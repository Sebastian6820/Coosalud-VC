
CREATE OR REPLACE TABLE DWH_PRODUCCION.FINANCIERA.S_DEPURACION_CARTERA AS
SELECT
    A.NIT_PROVEEDOR,
    A.NOMBRE_PROVEEDOR,
    NULL AS PREFIJO,
    A.NO_FACTURA_GENERAL AS FACTURA_PRESTADOR,
    NULL AS PREFIJO_Y_FACTURA_PRESTADOR,
    sum(A.VALOR_TOTAL_DETALLE) AS TOTAL_VALOR_RADICADO,
    A.CODIGO_RADICACION AS NRO_RADICADO_OPERADOR,
    A.FECHA_RADICACION_FACTURA AS FECHA_RADICADION_OPERADOR,
    A.CODREGIMEN AS REGIMEN,
    A.MODALIDAD_CONTRATO_HOMOLOGADO AS TIPO_CONTRATO,
    NULL AS SI_RED_NO_RED,
    NULL AS FACTURA_NO_RADICADA,
    NULL AS FACTURAS_DEVUELTAS,
    NULL AS FACTURAS_EN_PROCESO,
    NULL AS FACTURAS_PENDIENTES_DE_INTERFASE,
    NULL AS DIFERENCIAS_EN_VALOR,
    sum(A.VALOR_COPAGO) AS COPAGOS,
    sum(B.CUOTAMODERADORA) AS CUOTAS_MODERADORAS,
    sum(A.VALOR_TOTAL_GLOSADO) AS VALOR_GLOSA_INICIAL,
    NULL AS VALOR_GLOSA_ACEPTADA_IPS,
    NULL AS GLOSA_ACEPTADA_EPS,
    NULL AS GLOSA_PENDIENTE_DE_CONCILIAR,
    NULL AS IMPUESTOS_APLICADOS,
    NULL AS NOTAS_DEBITO,
    NULL AS FECHA_NOTA_DEBITO,
    NULL AS PAGOS_REALIZADOS,
    NULL AS FECHA_DE_PAGO,
    NULL AS LEGALIZACION_DE_ANTICIPOS_MEDICOS,
    NULL AS FECHA_LEGALIZACION_ANTICIPOS,
    NULL AS MAYORES_VALORES_PAGADOS,
    NULL AS CXP_SUBSIDIADO,
    NULL AS CXP_CONTRIBUTIVO,
    NULL AS VALIDACION,
    NULL AS OBSERVACIONES
FROM DWH_PRODUCCION.VAULT_FUENTES.S_FACTURACION_DETALLE_DEPURADO A 
LEFT JOIN (
    WITH t2 AS (
        SELECT DISTINCT 
            CARNET, subfactura, NUMFACTURA, NITPRESTADOR, CUOTAMODERADORA, CDCTIMESTAMP,
            ROW_NUMBER() OVER(PARTITION BY CARNET ORDER BY CDCTIMESTAMP DESC) AS row_n
        FROM DWH_PRODUCCION.EUREKA_APLISALUD.S_FACTURAS_DMS
    ) 
    SELECT * FROM t2 WHERE row_n = 1
) B 
ON A.NIT_PROVEEDOR || '-' || A.NO_SUBFACTURA || '-' || A.NO_CARNET = 
   B.NITPRESTADOR || '-' || B.subfactura || '-' || B.CARNET
   group by all;
 ;
